<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fill-in-the-Blank Quiz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #ccff99, #ffffff);
    }
    header {
      background: #ccff66;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #title {
      flex-grow: 1;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }
    .quiz-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .input-field {
      margin: 10px;
      padding: 10px;
      font-size: 22px;
      width: 200px;
    }
    .button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #007BFF;
      color: white;
    }
    .circle-button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      margin-left: 8px;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      font-size: 14px;
    }
    .progress-bar { width: 100%; background: #ddd; border-radius: 10px; margin-top: 20px; }
    .progress { height: 20px; background: #4CAF50; border-radius: 10px; width: 0%; }
    .hidden { display: none; }
    #question { font-size: 24px; margin-bottom: 10px; }
    #questionCount { font-size: 18px; margin-bottom: 20px; color: #555; }
    #translation { font-size: 20px; margin-top: 15px; }
  </style>
</head>
<body>
  <header>
    <label id="nameLabel">ÂêçÂâç: <input type="text" id="username" placeholder="Your name"></label>
    <div id="title">English Quiz</div>
    <div>
      <button class="button hidden" id="retryBtn">Retry Incorrect Questions</button>
      <button class="button hidden" id="pdfBtn">Download PDF</button>
      <button class="button hidden" id="pdfWrongBtn">Download Wrong Answers</button>
    </div>
  </header>

  <div class="quiz-container">
    <div id="questionCount"></div>
    <div id="question"></div>
    <div id="inputs"></div>
    <button class="button" id="submitBtn">Submit</button>
    <button class="button hidden" id="nextBtn">Next</button>
    <button class="button hidden" id="showAllBtn">Show All Results</button>
    <div id="feedback"></div>
    <div id="translation"></div>
    <div class="progress-bar" id="progressBar"><div class="progress" id="progress"></div></div>
    <div id="scoreBoard"></div>
  </div>

  <script>
    const originalQuestions = [
      { sentence: "The capital of Japan is ___ and it is famous for the Skytree.",
        answers: ["Tokyo"], translation: "The capital of Japan is Tokyo and it is famous for the Skytree.",
        jpTranslation: "Êó•Êú¨„ÅÆÈ¶ñÈÉΩ„ÅØÊù±‰∫¨„Åß„ÄÅ„Çπ„Ç´„Ç§„ÉÑ„É™„Éº„ÅåÊúâÂêç„Åß„Åô„ÄÇ", blanksTranslation: ["Êù±‰∫¨"] },
      { sentence: "Patients are ___ to infection just after surgery.",
        answers: ["vulnerable"], translation: "Patients are vulnerable to infection just after surgery.",
        jpTranslation: "ÊÇ£ËÄÖ„ÅØÊâãË°ì„ÅÆÁõ¥Âæå„ÄÅÊÑüÊüìÁóá„Å´„Åã„Åã„Çä„ÇÑ„Åô„Åè„Å™„Çã„ÄÇ", blanksTranslation: ["„Åã„Åã„Çä„ÇÑ„Åô„ÅÑ"] }
    ];

    let questions = [...originalQuestions];
    let current = 0, score = 0;
    let userAnswers = [], incorrectQuestions = [], retryMode = false;

    const qEl = document.getElementById("question");
    const qCountEl = document.getElementById("questionCount");
    const inputEl = document.getElementById("inputs");
    const feedbackEl = document.getElementById("feedback");
    const translationEl = document.getElementById("translation");
    const progressEl = document.getElementById("progress");
    const progressBar = document.getElementById("progressBar");
    const scoreBoard = document.getElementById("scoreBoard");
    const pdfBtn = document.getElementById("pdfBtn");
    const pdfWrongBtn = document.getElementById("pdfWrongBtn");
    const retryBtn = document.getElementById("retryBtn");
    const showAllBtn = document.getElementById("showAllBtn");
    const nameLabel = document.getElementById("nameLabel");

    function loadQuestion() {
      const q = questions[current];
      qCountEl.textContent = `Question ${current + 1} / ${questions.length}`;
      qEl.textContent = q.sentence;
      inputEl.innerHTML = "";
      feedbackEl.textContent = "";
      translationEl.textContent = "";

      q.answers.forEach((_, i) => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "input-field";
        inp.id = "ans" + i;
        inputEl.appendChild(inp);
      });

      // Enter„Ç≠„Éº„ÅßÊ¨°„ÅÆÂÖ•Âäõ or Submit
      const inputs = document.querySelectorAll(".input-field");
      inputs.forEach((inp, i) => {
        inp.addEventListener("keypress", e => {
          if (e.key === "Enter") {
            e.preventDefault();
            if (i < inputs.length - 1) {
              inputs[i + 1].focus();
            } else {
              checkAnswer();
            }
          }
        });
      });

      document.getElementById("submitBtn").classList.remove("hidden");
      document.getElementById("nextBtn").classList.add("hidden");
      progressEl.style.width = `${(current / questions.length) * 100}%`;
    }

    function checkAnswer() {
      const q = questions[current];
      let correct = true, answersGiven = [];

      q.answers.forEach((ans, i) => {
        const userAns = document.getElementById("ans" + i).value.trim();
        answersGiven.push(userAns);
        if (userAns.toLowerCase() !== ans.toLowerCase()) correct = false;
      });

      userAnswers.push({ question: q.sentence, user: answersGiven, correct: q.answers });

      if (correct) {
        feedbackEl.textContent = "‚úÖ Correct!";
        score++;
      } else {
        feedbackEl.textContent = "‚ùå Incorrect!";
        incorrectQuestions.push({ question: q.sentence, user: answersGiven, correct: q.answers });
      }

      let highlighted = q.translation;
      q.answers.forEach(ans => {
        const regex = new RegExp(`\\b${ans}\\b`, "gi");
        highlighted = highlighted.replace(regex, `<span style="color:red;">${ans}</span>`);
      });

      translationEl.innerHTML = `
        <p><b>Ëã±Êñá:</b> ${highlighted}</p>
        <p><b>Á≠î„Åà:</b> ${q.answers.join(", ")}</p>
        <p><b>ÂíåË®≥:</b> ${q.jpTranslation}</p>
        <p><b>Á≠î„Åà„ÅÆÂíåË®≥:</b> ${q.blanksTranslation.join(", ")}</p>
      `;

      // Èü≥Â£∞„Éú„Çø„É≥
      const speakBtnSentence = document.createElement("button");
      speakBtnSentence.textContent = "üîä";
      speakBtnSentence.className = "circle-button";
      speakBtnSentence.onclick = () => speak(q.translation);
      translationEl.querySelector("p").appendChild(speakBtnSentence);

      q.answers.forEach(ans => {
        const btnWord = document.createElement("button");
        btnWord.textContent = "üîä";
        btnWord.className = "circle-button";
        btnWord.onclick = () => speak(ans);
        translationEl.querySelector("p:nth-child(2)").appendChild(btnWord);
      });

      document.getElementById("submitBtn").classList.add("hidden");
      document.getElementById("nextBtn").classList.remove("hidden");
    }

    function nextQuestion() {
      current++;
      if (current < questions.length) {
        loadQuestion();
      } else {
        progressEl.style.width = "100%";
        scoreBoard.textContent = `Your score: ${score} / ${questions.length}`;
        progressBar.classList.add("hidden");
        showAllBtn.classList.remove("hidden");
        nameLabel.classList.add("hidden");
      }
    }

    function speak(text) {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      speechSynthesis.speak(u);
    }

    function showAllResults() {
      qEl.textContent = "All Results";
      qCountEl.textContent = "";
      inputEl.innerHTML = "";
      feedbackEl.textContent = "";
      translationEl.innerHTML = "";

      const username = document.getElementById("username").value.trim();
      translationEl.innerHTML = `<p><b>Name:</b> ${username || "(No name)"}</p>
                                 <p><b>Score:</b> ${score} / ${questions.length}</p>`;

      userAnswers.forEach((entry, idx) => {
        const div = document.createElement("div");
        div.style.textAlign = "left";
        div.style.margin = "10px";
        div.innerHTML = `
          <p><b>Q${idx + 1}:</b> ${entry.question}</p>
          <p>Your Answer: ${entry.user.join(", ")} | Correct: ${entry.correct.join(", ")}</p>
        `;
        translationEl.appendChild(div);
      });

      pdfBtn.classList.remove("hidden");
      pdfWrongBtn.classList.remove("hidden");
      if (incorrectQuestions.length > 0) retryBtn.classList.remove("hidden");

      showAllBtn.classList.add("hidden");
      document.getElementById("nextBtn").classList.add("hidden");
    }

    function downloadPDF(all = true) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const username = document.getElementById("username").value.trim();

      doc.setFontSize(14);
      if (all) {
        doc.text("Quiz Results", 10, 10);
      } else {
        doc.text("Wrong Vocabulary Results", 10, 10);
      }
      if (username) doc.text(`Name: ${username}`, 150, 10);
      doc.text(`Score: ${score} / ${questions.length}`, 10, 20);

      let y = 30;
      const data = all ? userAnswers : incorrectQuestions;

      data.forEach((entry, idx) => {
        const linesQ = doc.splitTextToSize(`${idx + 1}. Question: ${entry.question}`, 180);
        doc.text(linesQ, 10, y); y += linesQ.length * 8;

        const linesU = doc.splitTextToSize(`Your Answer: ${entry.user.join(", ")}`, 180);
        doc.text(linesU, 10, y); y += linesU.length * 8;

        const linesC = doc.splitTextToSize(`Correct Answer: ${entry.correct.join(", ")}`, 180);
        doc.text(linesC, 10, y); y += linesC.length * 8 + 5;

        if (y > 270) { doc.addPage(); y = 20; }
      });

      doc.save(all ? "quiz_results.pdf" : "Wrong-vocab.pdf");
    }

    pdfBtn.onclick = () => downloadPDF(true);
    pdfWrongBtn.onclick = () => downloadPDF(false);
    document.getElementById("submitBtn").onclick = checkAnswer;
    document.getElementById("nextBtn").onclick = nextQuestion;
    showAllBtn.onclick = showAllResults;

    retryBtn.onclick = () => {
      retryMode = true;
      questions = incorrectQuestions.map(q => ({
        sentence: q.question,
        answers: q.correct,
        translation: q.translation || "",
        jpTranslation: q.jpTranslation || "",
        blanksTranslation: q.blanksTranslation || []
      }));
      current = 0;
      userAnswers = [];
      score = 0;
      incorrectQuestions = []; // „É™„Éà„É©„Ç§„ÅßÂÜçÂ∫¶ÈõÜË®à
      loadQuestion();
      retryBtn.classList.add("hidden");
      pdfBtn.classList.add("hidden");
      pdfWrongBtn.classList.add("hidden");
      showAllBtn.classList.add("hidden");
      progressBar.classList.remove("hidden");
      scoreBoard.textContent = "";
    };

    loadQuestion();
  </script>
</body>
</html>
